# 思考过程（内心OS）

我是一个前端工程师（具备全栈能力），从[电鸭](https://eleduck.com/posts/Jpf8Y9)看到`XMind`的招聘需求。`Remote`、`965`、`WLB`，对我非常有吸引力。沿着招聘信息一路点下去，最后看到了`Github`上的[作业](https://github.com/xmindltd/hiring)。其中前端的作业是要写一个[简易记账本](https://github.com/xmindltd/hiring/blob/master/frontend-1/README.md)，远程选手要加赛“一篇简单的文档来描述你对解决本题目时的思考过程，并对其中所遇到的问题和你的解决方案进行描述”。这篇文档，就是“加赛”的“思考过程”。

最开始看到这个“思考过程”的需求，心想要不要拔高一下逼格，直接写一个设计方案？我找出工作中用的模板，看了第一部分——项目背景，然后打消了这个念头，因为硬套这个形式的话，就失去了“思考过程”的灵魂，我想这不是你们的初衷。所以要放轻松，要用“意识流”的风格来写。

写文档，总得有个载体吧，作为一个程序员，用`Markdown`是得体的。但这个文件怎么命名呢？“思考过程”的英文怎么翻？谷歌翻译的结果，个个都嫌长。用拼音？会被鄙视。用汉字？会被无视……突然灵光一闪——`HeartOS`！**内心OS**，还自带`OS`光环，逼格满满，信达雅兼备，就它了。这才终于建起了文档，开始码字儿。

“基本需求”第一句话“你需要读取我们所提供的数据完成以下需求”，表明需要操作`File System`，也即不能单纯扔个`HTML`过去；再结合上文提到的“最终请使用网页的方式呈现”，这意味着不能用`Electron`等技术起一个桌面应用来操作`File System`，而必须起一个`Web`服务。

前端起`Web`服务，无疑要用`Nodejs`。但从哪儿开始呢？是从原生`Nodejs`开始，还是用`Express`、`Koa`，亦或是更重的`Egg.js`。原生`Nodejs`写服务器太麻烦了，而`Egg.js`又过重，体现不出服务器功底，所以采用`Express`、`Koa`似乎更合适一点。在`Express`和`Koa`之间，就没有什么好再犹豫的了，为了`async`舒服，直接`Koa`。

那么`Browser`端呢？写原生`js`或`jQuery`肯定是不合适的。原生`js`装逼过度，并且用不到现代化的打包工具，技术展示不全面。`jQuery`就更不用想了，逼格不够，还显得古董，所以得上`React`或`Vue`。你说`Angular`？很抱歉，我历经的公司就没用这个的。至于在`React`或`Vue`之间，`Vue`文档对中文友好，就选它了。

基本技术选型确定后，我就哐哐哐开始搭架子。`Server`端哗啦哗啦就起来了，但到`Browser`端的时候，我突然意识到，选`Vue`是需要打包的，或曰需要`Webpack`。干这么多年，`Webpack`从零配置的次数屈指可数，并且每次都很不愉快。而配好之后，过段时间就忘了（现在就处在已经忘了的状态），又要重新查文档，又要重复我自己……`pack`可以，但咱能不能不`Webpack`？虽然也要查文档，但至少能学点儿新的。这时我突然想起前几天朋友圈一哥们发的`Bundleless`，是不是可以趁机玩玩这个？于是又`Google`了一番`Bundleless`，最终选定了尤大出品的`Vite`。`Vite`只编译，不打包，利用现代浏览器自带的`ESM`机制，配置简单多了。

`Demo`唰唰就跑起来了，但马上就面临一个问题，那就是这个项目因为要读`CSV`文件，进而要起`Server`，也就意味着不能用`Vite`自带的`Dev Server`，而必须用`Middleware`模式。可能是`Vite`的文档不够好，也可能是我水平比较差，奋斗了`2`个小时，`Middleware`模式没跑起来。

要继续`Middleware`下去吗？那再用`2`小时能搞定吗？成本是不是太高了？能不能换个路子？直观的想法是，开发环境`Koa`和`Vite`同时启，然后生产环境再切成纯`Koa`。因为生产环境是`Build`之后的，所以不需要`Vite Dev Server`的一系列功能。但测试环境这样搞的话，意味着会有两个`Port`，`Web`服务用的是`Vite Dev Server`的`Port`，`API`用的是`Koa`的`Port`。如果不做任何处理，会导致开发环境和线上环境的`Web`服务器`Port`不一致，显得太业余了。

那这个问题能不能解决呢？能！包一层`Proxy`。于是我引入了`koa-proxies`。但这个包有个缺点，就是代理**根路由**的时候，所有的请求都会被代理到`target`下，因而我自己写的`API`接口也就被覆盖了。现在我有两个选择：一是把`koa-proxies`源码看明白，看有没有文档里没写的配置手段；二是自己实现一个`Proxy`。看源码的成本太高了，我决定抛开`koa-proxies`自己干。我用`request`自己做了请求转发，解决了这个问题。

终于可以开始写业务了！等等，第二条说“以列表的形式展示账单内容，并且提供下拉框选择月份进行筛选，其中列表中所展示的账单为选择月份的账单”。既然有列表，那肯定要考虑分页；既然有分页，又有月份筛选，那意味着得有数据库。`Nodejs`是可以读`CSV`，但我不能把整个`CSV`读进内存里，然后做筛选吧？再说还要分页呢，读进内存做分页不是自欺欺人吗？况且第三条还要“支持使用者添加账单”……什么？要弄一个`DB`？`MySQL`我是不会用的，因为就没用过；`Mongo`我用过，也是在生产环境用的，但我不想做个作业再牵扯个`DB`进来。再说还要“附带一份文档以告诉我们要如何对你的代码进行使用、运行和测试，包括所需要准备的操作系统、运行环境等”，搞个`DB`还会增加这个文档的复杂度。万一文档没写好，人家跑不起来，那不白干了嘛！不上`DB`，坚决不上`DB`。

要不还是把`CSV`读进内存吧，业务需求能满足，说不定人家也不要求这块。但是……但是……这样干能过得了自己这关吗？如果我用浏览器的`DB`，服务端只用`CSV`做数据同步呢？这样不光能持久化，因为不走网，体验还会比走服务端数据库好。查了下浏览器`DB`的文档，发现有`Web SQL`和`IndexedDB`两种，`Web SQL`是关系型的，`IndexedDB`是`NoSQL`的，考虑到`Mongo`的经验，还是`IndexedDB`吧。

查文档的过程中，[MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API)推荐了一个库——`ZangoDB`，说是“类似 MongoDB 的 IndexedDB 接口，支持 MongoDB 的大多数熟悉的过滤、投影、排序、更新和聚合功能”。如果用这个库，是不是可以证明，我不是不会`Mongo`，而只是不想把问题搞复杂？可查了下`ZangoDB`的[Github](https://github.com/erikolson186/zangodb)，发现它最近一次更新已经是`4`年以前了……算了，还是用`MDN`推荐的[Dexie.js](https://dexie.org/)吧！

数据的问题解决了，终于可以开心的做个切图仔，写我的老本行——`CSS`啦！等等，我要裸写吗？裸写的话要考验设计功底，做出来不好看怎么办？不行，还是得用个`UI`框架。用哪个呢？工作中用`ElementUI`比较多，就它吧。`ElementUI`……`ElementUI`是`Vue 2.x`，可我已经用了`Vite`，`Vite`出来的项目是`Vue 3.x`……还能有这坑？我有点儿崩溃。不过一查，原来人家`ElementUI`有`Element Plus`，支持`Vue 3.x`，真是峰回路转啊。打开文档一看，不光支持`Vue 3.x`，还自带`ts`支持。你看这`ts`，说不定也是个考点，让我照着文档从头儿配的话，也是个麻烦事儿，现在人家自动支持了，真是老天保佑。

分分钟，一个支持搜索的账单列表做出来了，`Element Plus`的`UI`看上去还真不赖！但是，`ElementUI`是`PC`端框架，这里会不会要求适配`H5`？战战兢兢地把`Chrome`调试工具切换到手机模式，看上去还不错，稍微写了几行`CSS`，搞了下搜索项的折行，`UI`这块就算过了吧。

接下来做添加账单，这块我为难了。因为用的是`IndexedDB`，那意味着添加账单是添加到`Browser`数据库的，没有持久化到服务器上。如果要持久化到服务器，那就意味着还得用`MongoDB`，之前好不容易躲掉的`DB`，现在又要加回去，有点儿不甘心。想了想，要不直接写`CSV`吧？可写`CSV`有增量的方法吗？好像没有，搞不好我还得全部读进内存，数据处理完后全量写回去，这是一个程序员能干的事儿吗？生产环境真这样搞抗不了几个`QPS`啊！如果考虑并发，那是不是可以考虑先写`IndexedDB`，然后隔段时间同步到服务器，写一次`CSV`，这样原则上能解决并发问题。嗯，就这样干。于是三下五去二写完添加功能，终于要开始写数据同步逻辑了，然后我又犹豫了。如果是真实的生产环境，这里肯定是要用一个`DB`的，之前为了自己省事儿，特意把`DB`给省了，所以才有了数据同步的问题。那现在这个`CSV`的数据同步，岂不是一个永远不会在线上实施的方案？一想到这点，做数据同步的热情一下就没了。可以接受的选择只有两个：一个是直接上`MongoDB`；一个是用`IndexedDB`，放弃数据同步。最后我放弃了数据同步……我实在是太懒了……

添加账单的功能做完，“展示所选月份的收入和支出总金额”就不是什么难事儿了。其实不光可以“展示所选月份的收入和支出总金额”，按任意筛选组合都可以展示收入、支出总金额，基本没有额外的工作量。

继续往下看，“如果你需要应聘的岗位为高级前端工程师或以上岗位，则需要完成以下附加需求”。看了下附加需求，只是多了个按账单分类筛选，再加一个排序，并不难，也是三下五去二就做完了。但做完之后，我觉得这里有些不对劲儿。需求上说“根据账单分类进行支出金额统计”，但作为二次筛选，在选完月份之后，一个账单分类——比如房贷——一般只有一条数据，没有排序的余地啊！所以是不是需求写错了？这里想要的二次筛选其实不是“账单分类”，而是“账单类型”，也就是“收入”和“支出”？联系不上产品经理，就只能自己拿主意了，为了`965的Remote`，干脆都做了得了，于是把按“账单类型”筛选也做上去了。

做完按账单类型筛选，我发现排序又遇到一个问题。按金额排序，希望的肯定是全部数据的排序，而不是`ElTable`自带的当前页排序。用`IndexedDB`实现全部数据的排序并不难，难的是如果当前页码不是在第`1`页，比如是在第`2`页，那数据全排的时候，第`2`页展示的内容就会跟之前展示的内容完全无关。但如果点排序的时候，自动把页码重置到`1`，似乎也不妥。搜索的时候，把页码重置到`1`是天经地义的，但排序的时候，交互上一般是不影响页码的。但跟按“账单分类”筛选这个问题一样，我联系不上产品经理，就只能按我自己的理解来了。最后我选择了用`IndexedDB`做了数据全排，排序的时候保持页码不变。

至此功能上已经大功告成，但这么好的工作，肯定竞争者众，我还能玩出点儿什么花儿呢？要不要来个`Wasm`？嗯……我可以用`Rust`的`Yew`库，2017年还给他们贡献过代码，说出去也是逼格满满。但从2017年到现在，已经五年了，工作中从来没用过`Rust`，当年的激情也在“借来借去”的变量中消磨干净，现在弄这个，没一天时间估计下不来。那还能玩点儿啥呢？从业务上讲，一个记账本应该不是单单为了记账吧，肯定是为了从这些数据里分析出点儿东西，服务与“财务自由”什么的！嗯，可以用`Julia`分析一下，前端用`Pluto.jl`来呈现，也算`Web`技术。可这样一来，不光我自己要额外支出三四个小时，还要求面试官装`Julia`环境？这合适吗？万一面试官有洁癖，不想在自己电脑上装乱七八糟的东西，或者安装过程中出现问题，那不是自找不愉快嘛！要干这个，估计还得上`Docker`。说道`Docker`，也是配完就忘的玩意儿，折腾这个估计又得一下午，想想还是算了。

但不做，不影响我说啊。嗯，可以在`HeartOS`里先吹个牛，希望能加点儿`buff`吧！